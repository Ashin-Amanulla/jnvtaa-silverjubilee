name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/backend.yml"

jobs:
  deploy:
    name: Build & Deploy Backend (Docker)
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: ./backend
        run: |
          echo "NODE_ENV=production" > .env
          echo "PORT=5454" >> .env
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env
          echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
          echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
          echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env
          echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> .env
          echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> .env

      - name: Build Docker image
        working-directory: ./backend
        run: docker build -t jnvtaa-backend:latest .

      - name: Stop existing container
        run: |
          if docker ps -a --format '{{.Names}}' | grep -q jnvtaa-backend; then
            docker stop jnvtaa-backend
            docker rm jnvtaa-backend
          fi

      - name: Run new container
        working-directory: ./backend
        run: |
          docker run -d \
            --name jnvtaa-backend \
            --env-file .env \
            -p 5454:5454 \
            --restart unless-stopped \
            jnvtaa-backend:latest

      - name: Verify container
        run: docker ps | grep jnvtaa-backend
